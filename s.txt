import { useState } from 'react';
import { Link, router } from '@inertiajs/react';
import AuthenticatedLayout from '@/Layouts/AuthenticatedLayout';
import PageHeader from '@/Components/PageHeader';
import Card from '@/Components/Card';
import {
  ArrowRight,
  Users,
  Truck,
  DollarSign,
  Calendar,
  User,
  CheckCircle,
  Clock,
  Ban,
  RefreshCw,
  CreditCard,
  Building2,
  FileText,
  Eye,
  Printer,
  Download,
  Edit,
  Image as ImageIcon,
  File,
  AlertCircle,
  QrCode,
  Copy,
  ExternalLink,
  ChevronLeft,
  ChevronRight,
  Maximize2,
  Minimize2,
  X,
  Receipt,
  Percent,
  TrendingDown,
  TrendingUp
} from 'lucide-react';

// AttachmentModal Component (Ù‡Û•Ù…Ø§Ù†Û•)
const AttachmentModal = ({ attachment, onClose }) => {
  if (!attachment) return null;

  const isImage = attachment.match(/\.(jpg|jpeg|png|gif|bmp|webp)$/i);
  const isPDF = attachment.match(/\.pdf$/i);
  const fileName = attachment.split('/').pop();
  const fileUrl = `/storage/${attachment}`;
  const [isFullscreen, setIsFullscreen] = useState(false);

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-90">
      <div className={`relative w-full bg-black rounded-lg ${isFullscreen ? 'h-screen' : 'max-w-4xl max-h-[90vh]'}`}>
        <div className="absolute top-0 left-0 right-0 z-10 flex items-center justify-between p-4 bg-gradient-to-b from-black/80 to-transparent">
          <div className="flex items-center gap-3">
            {isImage ? (
              <ImageIcon className="w-5 h-5 text-white" />
            ) : (
              <FileText className="w-5 h-5 text-white" />
            )}
            <h3 className="font-semibold text-white">
              {fileName}
            </h3>
          </div>
          <div className="flex items-center gap-2">
            <button
              onClick={() => setIsFullscreen(!isFullscreen)}
              className="p-2 text-white transition-colors rounded-lg hover:bg-white/20"
              title={isFullscreen ? "Ø¨Ú†ÙˆÙˆÚ©Ú©Ø±Ø¯Ù†Û•ÙˆÛ•" : "Ú¯Û•ÙˆØ±Û•Ú©Ø±Ø¯Ù†"}
            >
              {isFullscreen ? <Minimize2 className="w-5 h-5" /> : <Maximize2 className="w-5 h-5" />}
            </button>
            <a
              href={fileUrl}
              target="_blank"
              rel="noopener noreferrer"
              className="p-2 text-white transition-colors rounded-lg hover:bg-white/20"
              title="Ú©Ø±Ø¯Ù†Û•ÙˆÛ• Ù„Û• Ù¾Û•Ù†Ø¬Û•Ø±Û•ÛŒ Ù†ÙˆÛ"
            >
              <ExternalLink className="w-5 h-5" />
            </a>
            <a
              href={fileUrl}
              download
              className="p-2 text-white transition-colors rounded-lg hover:bg-white/20"
              title="Ø¯Ø§Ú¯Ø±ØªÙ†"
            >
              <Download className="w-5 h-5" />
            </a>
            <button
              onClick={onClose}
              className="p-2 text-white transition-colors rounded-lg hover:bg-white/20"
              title="Ø¯Ø§Ø®Ø³ØªÙ†"
            >
              <X className="w-6 h-6" />
            </button>
          </div>
        </div>

        <div className="flex items-center justify-center h-full p-4 pt-20">
          {isImage ? (
            <img
              src={fileUrl}
              alt={fileName}
              className="max-w-full max-h-full rounded-lg"
              style={{ objectFit: 'contain' }}
            />
          ) : isPDF ? (
            <div className="w-full h-full">
              <iframe
                src={fileUrl}
                title={fileName}
                className="w-full h-full border-0 rounded-lg"
              />
            </div>
          ) : (
            <div className="flex flex-col items-center justify-center h-full py-12">
              <File className="w-16 h-16 mb-4 text-white" />
              <p className="mb-4 text-white">ÙØ§ÛŒÙ„Û•Ú©Û• Ù†Û•ØªÙˆØ§Ù†Ø±Ø§ Ù¾ÛŒØ´Ø§Ù† Ø¨Ø¯Ø±ÛØª</p>
              <a
                href={fileUrl}
                download
                className="inline-flex items-center gap-2 px-6 py-3 font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700"
              >
                <Download className="w-4 h-4" />
                Ø¯Ø§Ú¯Ø±ØªÙ†
              </a>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

// PaymentReceipt Component (Ú†Û•Ù†Ø¯ Ú¯Û†Ú•Ø§Ù†Ú©Ø§Ø±ÛŒ Ø¨Û† Ù†ÛŒØ´Ø§Ù†Ø¯Ø§Ù†ÛŒ Ù‚Û•Ø±Ø²)
const PaymentReceipt = ({ payment, company, relatedDebtInfo, onClose }) => {
  const formatCurrency = (amount, curr) => {
    return new Intl.NumberFormat('ar-IQ').format(amount) + ' ' + (curr === 'IQD' ? 'Ø¯ÛŒÙ†Ø§Ø±' : 'Ø¯Û†Ù„Ø§Ø±');
  };

  const formatDate = (date) => {
    return new Date(date).toLocaleDateString('ar-IQ', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    });
  };

  const getStatusColor = (status) => {
    switch (status) {
      case 'completed': return 'bg-green-500';
      case 'pending': return 'bg-yellow-500';
      case 'cancelled': return 'bg-red-500';
      case 'refunded': return 'bg-blue-500';
      default: return 'bg-gray-500';
    }
  };

  const getPaymentMethodText = (method) => {
    switch (method) {
      case 'cash': return 'Ú©Ø§Ø´';
      case 'pos': return 'Ù¾Û†Ø³';
      case 'transfer': return 'Ú¯ÙˆØ§Ø³ØªÙ†Û•ÙˆÛ•';
      case 'cheque': return 'Ú†ÛÚ©';
      case 'other': return 'Ø¦Û•ÙˆØ§Ù†ÛŒ ØªØ±';
      default: return method;
    }
  };

  const getDebtStatus = () => {
    if (!relatedDebtInfo) return null;

    const remaining = relatedDebtInfo.remaining_amount;
    const original = relatedDebtInfo.total_amount;
    const paid = relatedDebtInfo.paid_amount;

    let status = '';
    let color = '';

    if (remaining === 0) {
      status = 'âœ… Ù‚Û•Ø±Ø² ØªÛ•ÙˆØ§Ùˆ Ú©Ø±Ø§ÙˆÛ•';
      color = 'text-green-700 bg-green-100';
    } else if (remaining === original) {
      status = 'âŒ Ù‡ÛØ´ØªØ§ Ù¾Ø§Ø±Û• Ù†Û•Ø¯Ø±Ø§ÙˆÛ•';
      color = 'text-red-700 bg-red-100';
    } else if (remaining < original) {
      const percentage = ((paid / original) * 100).toFixed(1);
      status = `â³ ${percentage}% Ù¾Ø§Ø±Û• Ø¯Ø±Ø§ÙˆÛ•`;
      color = 'text-blue-700 bg-blue-100';
    }

    return { status, color };
  };

  const handlePrint = () => {
    const printWindow = window.open('', '_blank');

    printWindow.document.write(`
      <!DOCTYPE html>
      <html lang="ar" dir="rtl">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Ø³Û•Ù†Ø¯ Ù‚Ø¨Ø¶ - ${payment.reference_number || payment.id}</title>
        <style>
          @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@100;200;300;400;500;600;700&display=swap');

          * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
          }

          body {
            background: white;
            padding: 20px;
            direction: rtl;
          }

          .receipt {
            max-width: 800px;
            margin: 0 auto;
            border: 2px solid #333;
            border-radius: 10px;
            padding: 20px;
            position: relative;
          }

          .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #333;
          }

          .company-name {
            font-size: 28px;
            font-weight: 800;
            color: #1e40af;
            margin-bottom: 5px;
          }

          .receipt-title {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin: 15px 0;
          }

          .receipt-type {
            display: inline-block;
            padding: 5px 15px;
            background: ${payment.type === 'customer' ? '#3b82f6' : '#8b5cf6'};
            color: white;
            border-radius: 20px;
            font-weight: 600;
          }

          .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 25px 0;
          }

          .info-item {
            margin-bottom: 15px;
          }

          .info-label {
            font-weight: 600;
            color: #666;
            margin-bottom: 5px;
          }

          .debt-section {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 2px solid #f59e0b;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
          }

          .debt-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            text-align: center;
          }

          .debt-item {
            padding: 10px;
            background: white;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
          }

          .debt-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 5px;
          }

          .debt-value {
            font-size: 16px;
            font-weight: 700;
            color: #111827;
          }

          .amount-section {
            text-align: center;
            padding: 30px;
            margin: 30px 0;
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            border-radius: 15px;
            border: 2px solid #10b981;
          }

          .amount-value {
            font-size: 48px;
            font-weight: 900;
            color: #059669;
            margin: 10px 0;
          }

          .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: 600;
            margin-top: 15px;
            background: ${getStatusColor(payment.status)};
            color: white;
          }

          .signature-section {
            display: flex;
            justify-content: space-between;
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px dashed #ccc;
          }

          .signature-box {
            text-align: center;
          }

          .signature-line {
            width: 200px;
            height: 1px;
            background: #666;
            margin: 30px auto 10px;
          }

          .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ccc;
            color: #666;
            font-size: 12px;
          }

          @media print {
            body {
              padding: 0;
            }

            .receipt {
              border: none;
              padding: 10px;
            }
          }
        </style>
      </head>
      <body>
        <div class="receipt">
          <div class="header">
            <div class="company-name">${company?.name || 'Ú©Û†Ù…Ù¾Ø§Ù†ÛŒØ§ÛŒ Ø¨ÛÚ¯ÚµØ§Ø³'}</div>
            <div style="color: #666; margin-bottom: 10px;">${company?.address || ''}</div>
            <div class="receipt-type">Ø³Û•Ù†Ø¯ Ù‚Ø¨Ø¶ - ${payment.type === 'customer' ? 'ÙˆÛ•Ø±Ú¯Ø±ØªÙ† Ù„Û• Ú©Ú•ÛŒØ§Ø±' : 'Ø¯Ø§Ù†Û•ÙˆÛ• Ø¨Û† Ø¯Ø§Ø¨ÛŒÙ†Ú©Û•Ø±'}</div>
          </div>

          <div class="info-grid">
            <div>
              <div class="info-item">
                <div class="info-label">Ú˜Ù…Ø§Ø±Û•ÛŒ Ø³Û•Ù†Ø¯: ${payment.reference_number || payment.id}</div>
              </div>
              <div class="info-item">
                <div class="info-label">${payment.type === 'customer' ? 'Ú©Ú•ÛŒØ§Ø±:' : 'Ø¯Ø§Ø¨ÛŒÙ†Ú©Û•Ø±:'}</div>
                <div>${payment.type === 'customer' ? payment.customer?.name : payment.supplier?.name}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Ù…Û†Ø¨Ø§ÛŒÙ„:</div>
                <div>${payment.type === 'customer' ? payment.customer?.phone : payment.supplier?.phone}</div>
              </div>
            </div>

            <div>
              <div class="info-item">
                <div class="info-label">Ø¨Û•Ø±ÙˆØ§Ø±ÛŒ ÙˆÛ•Ø±Ú¯Ø±ØªÙ†:</div>
                <div>${formatDate(payment.payment_date)}</div>
              </div>
              <div class="info-item">
                <div class="info-label">Ø´ÛÙˆØ§Ø²ÛŒ Ù¾Ø§Ø±Û•Ø¯Ø§Ù†:</div>
                <div>${getPaymentMethodText(payment.payment_method)}</div>
              </div>
              <div class="info-item">
                <div class="info-label">ÙˆÛ•Ø±Ú¯Ø±:</div>
                <div>${payment.user?.name}</div>
              </div>
            </div>
          </div>

          ${relatedDebtInfo ? `
          <div class="debt-section">
            <div style="text-align: center; margin-bottom: 15px; font-weight: 700; color: #92400e;">Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ Ù‚Û•Ø±Ø²</div>
            <div class="debt-grid">
              <div class="debt-item">
                <div class="debt-label">Ú©Û†ÛŒ Ù‚Û•Ø±Ø²</div>
                <div class="debt-value">${new Intl.NumberFormat('ar-IQ').format(relatedDebtInfo.total_amount)} ${payment.currency === 'IQD' ? 'Ø¯ÛŒÙ†Ø§Ø±' : 'Ø¯Û†Ù„Ø§Ø±'}</div>
              </div>
              <div class="debt-item">
                <div class="debt-label">Ù¾Ø§Ø±Û•ÛŒ Ø¯Ø±Ø§Ùˆ</div>
                <div class="debt-value">${new Intl.NumberFormat('ar-IQ').format(relatedDebtInfo.paid_amount)} ${payment.currency === 'IQD' ? 'Ø¯ÛŒÙ†Ø§Ø±' : 'Ø¯Û†Ù„Ø§Ø±'}</div>
              </div>
              <div class="debt-item">
                <div class="debt-label">Ù¾Ø§Ø±Û•ÛŒ Ù…Ø§ÙˆÛ•</div>
                <div class="debt-value">${new Intl.NumberFormat('ar-IQ').format(relatedDebtInfo.remaining_amount)} ${payment.currency === 'IQD' ? 'Ø¯ÛŒÙ†Ø§Ø±' : 'Ø¯Û†Ù„Ø§Ø±'}</div>
              </div>
            </div>
          </div>
          ` : ''}

          <div class="amount-section">
            <div style="font-size: 20px; color: #333;">Ø¨Ú•ÛŒ Ø¦Û•Ù… Ù¾Ø§Ø±Û•Ø¯Ø§Ù†Û•</div>
            <div class="amount-value">${new Intl.NumberFormat('ar-IQ').format(payment.amount)} ${payment.currency === 'IQD' ? 'Ø¯ÛŒÙ†Ø§Ø±' : 'Ø¯Û†Ù„Ø§Ø±'}</div>
            <div style="margin-top: 10px;">
              <span class="status-badge">
                ${payment.status === 'completed' ? 'âœ… ØªÛ•ÙˆØ§ÙˆØ¨ÙˆÙˆ' :
                  payment.status === 'pending' ? 'â³ Ú†Ø§ÙˆÛ•Ú•ÙˆØ§Ù†ÛŒ' :
                  payment.status === 'cancelled' ? 'âŒ Ù‡Û•ÚµÙˆÛ•Ø´Ø§ÙˆÛ•' : 'ğŸ”„ Ú¯Û•Ú•Ø§ÙˆÛ•ØªÛ•ÙˆÛ•'}
              </span>
            </div>
          </div>

          <div class="signature-section">
            <div class="signature-box">
              <div>ÙˆØ§Ú˜Û†ÛŒ ${payment.type === 'customer' ? 'Ú©Ú•ÛŒØ§Ø±' : 'Ø¯Ø§Ø¨ÛŒÙ†Ú©Û•Ø±'}</div>
              <div class="signature-line"></div>
              <div style="margin-top: 5px;">${payment.type === 'customer' ? payment.customer?.name : payment.supplier?.name}</div>
            </div>

            <div class="signature-box">
              <div>ÙˆØ§Ú˜Û†ÛŒ ÙˆÛ•Ø±Ú¯Ø±</div>
              <div class="signature-line"></div>
              <div style="margin-top: 5px;">${payment.user?.name}</div>
            </div>
          </div>

          <div class="footer">
            <div>ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø§ÙˆÛ• Ù„Û•: ${formatDate(payment.created_at)}</div>
            <div style="margin-top: 10px;">Â© ${new Date().getFullYear()} ${company?.name || 'Ú©Û†Ù…Ù¾Ø§Ù†ÛŒØ§ÛŒ Ø¨ÛÚ¯ÚµØ§Ø³'}</div>
          </div>
        </div>

        <script>
          window.onload = function() {
            window.print();
            setTimeout(() => {
              window.close();
            }, 1000);
          }
        </script>
      </body>
      </html>
    `);

    printWindow.document.close();
  };

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-75">
      <div className="relative w-full max-w-4xl bg-white shadow-2xl rounded-2xl">
        <div className="absolute top-0 left-0 right-0 z-10 flex items-center justify-between p-6 text-white bg-gradient-to-r from-green-600 to-emerald-700 rounded-t-2xl">
          <div className="flex items-center gap-3">
            <Receipt className="w-6 h-6" />
            <h2 className="text-xl font-bold">Ø³Û•Ù†Ø¯ Ù‚Ø¨Ø¶ - ÙˆÛ•Ø±Ú¯Ø±ØªÙ†ÛŒ Ù¾Ø§Ø±Û•</h2>
          </div>
          <div className="flex items-center gap-2">
            <button
              onClick={handlePrint}
              className="flex items-center gap-2 px-4 py-2 text-sm font-bold text-white bg-blue-600 rounded-lg hover:bg-blue-700"
            >
              <Printer className="w-4 h-4" />
              Ú†Ø§Ù¾Ú©Ø±Ø¯Ù†
            </button>
            <button
              onClick={onClose}
              className="p-2 text-white rounded-lg hover:bg-white/20"
            >
              <X className="w-6 h-6" />
            </button>
          </div>
        </div>

        <div className="p-8 mt-16 max-h-[80vh] overflow-y-auto">
          <div className="p-8 border-4 border-green-200 rounded-2xl">
            <div className="pb-8 mb-8 text-center border-b-2 border-gray-200">
              <div className="mb-2 text-3xl font-black text-green-600">{company?.name || 'Ú©Û†Ù…Ù¾Ø§Ù†ÛŒØ§'}</div>
              <div className="text-gray-600">{company?.address || 'Ù†Ø§ÙˆÙ†ÛŒØ´Ø§Ù†'}</div>
              <div className="mt-4">
                <span className="px-6 py-2 text-lg font-bold bg-green-100 text-green-800 rounded-full">
                  Ø³Û•Ù†Ø¯ Ù‚Ø¨Ø¶ - ${payment.type === 'customer' ? 'ÙˆÛ•Ø±Ú¯Ø±ØªÙ† Ù„Û• Ú©Ú•ÛŒØ§Ø±' : 'Ø¯Ø§Ù†Û•ÙˆÛ• Ø¨Û† Ø¯Ø§Ø¨ÛŒÙ†Ú©Û•Ø±'}
                </span>
              </div>
            </div>

            <div className="grid grid-cols-1 gap-8 mb-8 md:grid-cols-2">
              <div>
                <div className="mb-4">
                  <div className="text-sm text-gray-500">Ú˜Ù…Ø§Ø±Û•ÛŒ Ø³Û•Ù†Ø¯</div>
                  <div className="text-xl font-bold text-gray-900">{payment.reference_number || payment.id}</div>
                </div>
                <div className="mb-4">
                  <div className="text-sm text-gray-500">${payment.type === 'customer' ? 'Ú©Ú•ÛŒØ§Ø±' : 'Ø¯Ø§Ø¨ÛŒÙ†Ú©Û•Ø±'}</div>
                  <div className="text-lg font-semibold text-gray-900">
                    {payment.type === 'customer' ? payment.customer?.name : payment.supplier?.name}
                  </div>
                </div>
                <div>
                  <div className="text-sm text-gray-500">Ù…Û†Ø¨Ø§ÛŒÙ„</div>
                  <div className="text-gray-900">
                    {payment.type === 'customer' ? payment.customer?.phone : payment.supplier?.phone}
                  </div>
                </div>
              </div>

              <div>
                <div className="mb-4">
                  <div className="text-sm text-gray-500">Ø¨Û•Ø±ÙˆØ§Ø±ÛŒ ÙˆÛ•Ø±Ú¯Ø±ØªÙ†</div>
                  <div className="text-gray-900">{formatDate(payment.payment_date)}</div>
                </div>
                <div className="mb-4">
                  <div className="text-sm text-gray-500">Ø´ÛÙˆØ§Ø²ÛŒ Ù¾Ø§Ø±Û•Ø¯Ø§Ù†</div>
                  <div className="font-semibold text-gray-900">{getPaymentMethodText(payment.payment_method)}</div>
                </div>
                <div>
                  <div className="text-sm text-gray-500">ÙˆÛ•Ø±Ú¯Ø±</div>
                  <div className="text-gray-900">{payment.user?.name}</div>
                </div>
              </div>
            </div>

            {/* Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ Ù‚Û•Ø±Ø² */}
            {relatedDebtInfo && (
              <div className="p-6 mb-8 border-2 border-amber-200 bg-gradient-to-r from-amber-50 to-yellow-50 rounded-2xl">
                <div className="mb-4 text-lg font-bold text-amber-800">ğŸ’° Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ Ù‚Û•Ø±Ø²</div>
                <div className="grid grid-cols-1 gap-4 md:grid-cols-3">
                  <div className="p-4 text-center border-2 border-amber-300 bg-white rounded-xl">
                    <div className="mb-1 text-sm text-gray-600">Ú©Û†ÛŒ Ù‚Û•Ø±Ø²</div>
                    <div className="text-xl font-black text-gray-900">
                      {new Intl.NumberFormat('ar-IQ').format(relatedDebtInfo.total_amount)} {payment.currency === 'IQD' ? 'Ø¯ÛŒÙ†Ø§Ø±' : 'Ø¯Û†Ù„Ø§Ø±'}
                    </div>
                  </div>
                  <div className="p-4 text-center border-2 border-green-300 bg-white rounded-xl">
                    <div className="mb-1 text-sm text-gray-600">Ù¾Ø§Ø±Û•ÛŒ Ø¯Ø±Ø§Ùˆ</div>
                    <div className="text-xl font-black text-green-600">
                      {new Intl.NumberFormat('ar-IQ').format(relatedDebtInfo.paid_amount)} {payment.currency === 'IQD' ? 'Ø¯ÛŒÙ†Ø§Ø±' : 'Ø¯Û†Ù„Ø§Ø±'}
                    </div>
                  </div>
                  <div className="p-4 text-center border-2 border-red-300 bg-white rounded-xl">
                    <div className="mb-1 text-sm text-gray-600">Ù¾Ø§Ø±Û•ÛŒ Ù…Ø§ÙˆÛ•</div>
                    <div className="text-xl font-black text-red-600">
                      {new Intl.NumberFormat('ar-IQ').format(relatedDebtInfo.remaining_amount)} {payment.currency === 'IQD' ? 'Ø¯ÛŒÙ†Ø§Ø±' : 'Ø¯Û†Ù„Ø§Ø±'}
                    </div>
                  </div>
                </div>
                {getDebtStatus() && (
                  <div className={`mt-4 inline-block px-4 py-2 rounded-lg ${getDebtStatus().color}`}>
                    {getDebtStatus().status}
                  </div>
                )}
              </div>
            )}

            <div className="py-8 mb-8 text-center border-2 border-emerald-200 bg-gradient-to-r from-emerald-50 to-teal-50 rounded-2xl">
              <div className="mb-2 text-lg text-gray-600">Ø¨Ú•ÛŒ Ø¦Û•Ù… Ù¾Ø§Ø±Û•Ø¯Ø§Ù†Û•</div>
              <div className="mb-2 text-5xl font-black text-emerald-600">
                {new Intl.NumberFormat('ar-IQ').format(payment.amount)}
              </div>
              <div className="text-2xl font-bold text-gray-700">
                {payment.currency === 'IQD' ? 'Ø¯ÛŒÙ†Ø§Ø±' : 'Ø¯Û†Ù„Ø§Ø±'}
              </div>
              <div className={`mt-4 inline-flex items-center gap-2 px-6 py-2 rounded-full font-bold ${
                payment.status === 'completed' ? 'bg-green-100 text-green-800' :
                payment.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                payment.status === 'cancelled' ? 'bg-red-100 text-red-800' :
                'bg-blue-100 text-blue-800'
              }`}>
                {payment.status === 'completed' ? 'âœ… ØªÛ•ÙˆØ§ÙˆØ¨ÙˆÙˆ' :
                 payment.status === 'pending' ? 'â³ Ú†Ø§ÙˆÛ•Ú•ÙˆØ§Ù†ÛŒ' :
                 payment.status === 'cancelled' ? 'âŒ Ù‡Û•ÚµÙˆÛ•Ø´Ø§ÙˆÛ•' : 'ğŸ”„ Ú¯Û•Ú•Ø§ÙˆÛ•ØªÛ•ÙˆÛ•'}
              </div>
            </div>

            {payment.notes && (
              <div className="p-6 mb-8 border-2 border-blue-200 bg-blue-50 rounded-2xl">
                <div className="mb-3 text-lg font-bold text-blue-800">ğŸ“ ØªÛØ¨ÛŒÙ†ÛŒ:</div>
                <div className="text-gray-700 whitespace-pre-line">{payment.notes}</div>
              </div>
            )}

            <div className="flex justify-between pt-8 border-t-2 border-gray-200">
              <div className="text-center">
                <div className="mb-2 font-bold text-gray-700">ÙˆØ§Ú˜Û†ÛŒ ${payment.type === 'customer' ? 'Ú©Ú•ÛŒØ§Ø±' : 'Ø¯Ø§Ø¨ÛŒÙ†Ú©Û•Ø±'}</div>
                <div className="w-48 h-px mx-auto mb-2 bg-gray-400"></div>
                <div className="text-gray-600">{payment.type === 'customer' ? payment.customer?.name : payment.supplier?.name}</div>
              </div>

              <div className="text-center">
                <div className="mb-2 font-bold text-gray-700">ÙˆØ§Ú˜Û†ÛŒ ÙˆÛ•Ø±Ú¯Ø±</div>
                <div className="w-48 h-px mx-auto mb-2 bg-gray-400"></div>
                <div className="text-gray-600">{payment.user?.name}</div>
              </div>
            </div>

            <div className="pt-6 mt-8 text-sm text-center text-gray-500 border-t border-gray-300">
              <div>ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø§ÙˆÛ• Ù„Û•: {formatDate(payment.created_at)}</div>
              <div className="mt-1">Â© {new Date().getFullYear()} {company?.name || 'Ú©Û†Ù…Ù¾Ø§Ù†ÛŒØ§'} - Ù‡Û•Ù…ÙˆÙˆ Ù…Ø§ÙÛ•Ú©Ø§Ù† Ù¾Ø§Ø±ÛØ²Ø±Ø§ÙˆÙ†</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

// QuickInfoCard Component (Ù‡Û•Ù…Ø§Ù†Û•)
const QuickInfoCard = ({ icon: Icon, label, value, color = "blue", action }) => {
  const colorClasses = {
    blue: 'bg-blue-50 border-blue-200 text-blue-700',
    green: 'bg-green-50 border-green-200 text-green-700',
    purple: 'bg-purple-50 border-purple-200 text-purple-700',
    yellow: 'bg-yellow-50 border-yellow-200 text-yellow-700',
    red: 'bg-red-50 border-red-200 text-red-700',
    amber: 'bg-amber-50 border-amber-200 text-amber-700',
    emerald: 'bg-emerald-50 border-emerald-200 text-emerald-700',
  };

  return (
    <div className={`p-4 border-2 rounded-xl ${colorClasses[color]}`}>
      <div className="flex items-start justify-between">
        <div className="flex items-center gap-3">
          <div className="p-2 bg-white rounded-lg">
            <Icon className="w-5 h-5" />
          </div>
          <div>
            <div className="text-sm font-medium opacity-80">{label}</div>
            <div className="mt-1 text-lg font-bold">{value}</div>
          </div>
        </div>
        {action && (
          <button
            onClick={action.onClick}
            className="p-2 transition-colors rounded-lg hover:bg-white/50"
            title={action.title}
          >
            {action.icon && <action.icon className="w-4 h-4" />}
          </button>
        )}
      </div>
    </div>
  );
};

// DebtProgress Component (Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ Ù¾ÛØ´Ú©Û•ÙˆØªÙ†ÛŒ Ù‚Û•Ø±Ø²)
const DebtProgress = ({ total, paid, remaining, currency }) => {
  const percentage = total > 0 ? (paid / total) * 100 : 0;

  const formatCurrency = (amount) => {
    return new Intl.NumberFormat('ar-IQ').format(amount) + ' ' + (currency === 'IQD' ? 'Ø¯ÛŒÙ†Ø§Ø±' : 'Ø¯Û†Ù„Ø§Ø±');
  };

  return (
    <div className="p-4 border-2 border-amber-200 bg-gradient-to-r from-amber-50 to-yellow-50 rounded-2xl">
      <div className="mb-3 font-bold text-amber-800">ğŸ“Š Ù¾ÛØ´Ú©Û•ÙˆØªÙ†ÛŒ Ù‚Û•Ø±Ø²</div>

      <div className="mb-4">
        <div className="flex justify-between mb-1 text-sm">
          <span className="text-gray-600">Ù¾Ø§Ø±Û•ÛŒ Ø¯Ø±Ø§Ùˆ: {formatCurrency(paid)}</span>
          <span className="font-bold text-amber-700">{percentage.toFixed(1)}%</span>
        </div>
        <div className="h-3 bg-gray-200 rounded-full overflow-hidden">
          <div
            className="h-full bg-gradient-to-r from-green-500 to-emerald-600 rounded-full transition-all duration-500"
            style={{ width: `${percentage}%` }}
          ></div>
        </div>
      </div>

      <div className="grid grid-cols-3 gap-3 text-center">
        <div className="p-2 bg-white border border-gray-300 rounded-lg">
          <div className="text-xs text-gray-600">Ú©Û†ÛŒ Ù‚Û•Ø±Ø²</div>
          <div className="font-bold text-gray-900">{formatCurrency(total)}</div>
        </div>
        <div className="p-2 bg-white border border-green-300 rounded-lg">
          <div className="text-xs text-gray-600">Ù¾Ø§Ø±Û•ÛŒ Ø¯Ø±Ø§Ùˆ</div>
          <div className="font-bold text-green-600">{formatCurrency(paid)}</div>
        </div>
        <div className="p-2 bg-white border border-red-300 rounded-lg">
          <div className="text-xs text-gray-600">Ù¾Ø§Ø±Û•ÛŒ Ù…Ø§ÙˆÛ•</div>
          <div className="font-bold text-red-600">{formatCurrency(remaining)}</div>
        </div>
      </div>
    </div>
  );
};

// Main Component
export default function Show({ payment, company = {}, relatedDebtInfo = null }) {
  const [showReceipt, setShowReceipt] = useState(false);
  const [showAttachment, setShowAttachment] = useState(null);
  const [copied, setCopied] = useState(false);

  const formatCurrency = (amount, curr) => {
    return new Intl.NumberFormat('ar-IQ').format(amount) + ' ' + (curr === 'IQD' ? 'Ø¯ÛŒÙ†Ø§Ø±' : 'Ø¯Û†Ù„Ø§Ø±');
  };

  const formatDate = (date) => {
    return new Date(date).toLocaleDateString('ar-IQ', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
    });
  };

  const getStatusIcon = (status) => {
    switch (status) {
      case 'completed':
        return <CheckCircle className="w-5 h-5 text-green-500" />;
      case 'pending':
        return <Clock className="w-5 h-5 text-yellow-500" />;
      case 'cancelled':
        return <Ban className="w-5 h-5 text-red-500" />;
      case 'refunded':
        return <RefreshCw className="w-5 h-5 text-blue-500" />;
      default:
        return null;
    }
  };

  const getStatusColor = (status) => {
    switch (status) {
      case 'completed':
        return 'bg-green-100 text-green-800 border-green-300';
      case 'pending':
        return 'bg-yellow-100 text-yellow-800 border-yellow-300';
      case 'cancelled':
        return 'bg-red-100 text-red-800 border-red-300';
      case 'refunded':
        return 'bg-blue-100 text-blue-800 border-blue-300';
      default:
        return 'bg-gray-100 text-gray-800 border-gray-300';
    }
  };

  const getStatusText = (status) => {
    switch (status) {
      case 'completed':
        return 'ØªÛ•ÙˆØ§ÙˆØ¨ÙˆÙˆ';
      case 'pending':
        return 'Ú†Ø§ÙˆÛ•Ú•ÙˆØ§Ù†ÛŒ';
      case 'cancelled':
        return 'Ù‡Û•ÚµÙˆÛ•Ø´Ø§ÙˆÛ•';
      case 'refunded':
        return 'Ú¯Û•Ú•Ø§ÙˆÛ•ØªÛ•ÙˆÛ•';
      default:
        return status;
    }
  };

  const getPaymentMethodIcon = (method) => {
    switch (method) {
      case 'cash':
        return DollarSign;
      case 'pos':
        return CreditCard;
      case 'transfer':
        return RefreshCw;
      case 'cheque':
        return FileText;
      case 'other':
        return DollarSign;
      default:
        return DollarSign;
    }
  };

  const getPaymentMethodText = (method) => {
    switch (method) {
      case 'cash':
        return 'Ú©Ø§Ø´';
      case 'pos':
        return 'Ù¾Û†Ø³';
      case 'transfer':
        return 'Ú¯ÙˆØ§Ø³ØªÙ†Û•ÙˆÛ•';
      case 'cheque':
        return 'Ú†ÛÚ©';
      case 'other':
        return 'Ø¦Û•ÙˆØ§Ù†ÛŒ ØªØ±';
      default:
        return method;
    }
  };

  const getPaymentMethodColor = (method) => {
    switch (method) {
      case 'cash':
        return 'green';
      case 'pos':
        return 'blue';
      case 'transfer':
        return 'purple';
      case 'cheque':
        return 'yellow';
      case 'other':
        return 'gray';
    }
  };

  const copyToClipboard = (text) => {
    navigator.clipboard.writeText(text).then(() => {
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    });
  };

  const handlePrintReceipt = () => {
    setShowReceipt(true);
  };

  // Ù‡Û•ÚµØ³Û•Ù†Ú¯Ø§Ù†Ø¯Ù†ÛŒ Ú©Ø§ØªÛŒ Ù¾Ø§Ø±Û•Ø¯Ø§Ù† (Ú•ÛÚ© ÛŒØ§Ù† Ù†Ø§Ú•ÛÚ©)
  const getPaymentTimingStatus = () => {
    if (!relatedDebtInfo?.due_date) return null;

    const paymentDate = new Date(payment.payment_date);
    const dueDate = new Date(relatedDebtInfo.due_date);
    const today = new Date();

    const diffTime = paymentDate - dueDate;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

    if (diffDays < 0) {
      return {
        text: `ğŸ’° Ù¾Ø§Ø±Û•Ø¯Ø§Ù† Ù¾ÛØ´ Ú©Ø§ØªÛŒ Ø¯ÛŒØ§Ø±ÛŒÚ©Ø±Ø§Ùˆ (${Math.abs(diffDays)} Ú•Û†Ú˜ Ù¾ÛØ´ØªØ±)`,
        color: 'text-green-700 bg-green-100',
        icon: TrendingDown
      };
    } else if (diffDays === 0) {
      return {
        text: 'â° Ù¾Ø§Ø±Û•Ø¯Ø§Ù† Ù„Û• Ú©Ø§ØªÛŒ Ø¯ÛŒØ§Ø±ÛŒÚ©Ø±Ø§Ùˆ',
        color: 'text-blue-700 bg-blue-100',
        icon: CheckCircle
      };
    } else {
      return {
        text: `â³ Ù¾Ø§Ø±Û•Ø¯Ø§Ù† Ø¯ÙˆØ§Ø®Ø±Ø§ÙˆÛ• (${diffDays} Ú•Û†Ú˜ Ø¯ÙˆØ§Ø®Ø±Ø§ÙˆÛ•)`,
        color: 'text-red-700 bg-red-100',
        icon: TrendingUp
      };
    }
  };

  const paymentTiming = getPaymentTimingStatus();

  // Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ Ø®ÛØ±Ø§
  const quickInfoCards = [
    {
      icon: payment.type === 'customer' ? Users : Truck,
      label: payment.type === 'customer' ? 'Ú©Ú•ÛŒØ§Ø±' : 'Ø¯Ø§Ø¨ÛŒÙ†Ú©Û•Ø±',
      value: payment.type === 'customer' ? payment.customer?.name : payment.supplier?.name,
      color: payment.type === 'customer' ? 'blue' : 'purple',
      action: payment.type === 'customer' ? {
        onClick: () => router.get(`/customers/${payment.customer_id}`),
        title: 'Ø¨ÛŒÙ†ÛŒÙ†ÛŒ Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ Ú©Ú•ÛŒØ§Ø±',
        icon: ExternalLink
      } : {
        onClick: () => router.get(`/suppliers/${payment.supplier_id}`),
        title: 'Ø¨ÛŒÙ†ÛŒÙ†ÛŒ Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ Ø¯Ø§Ø¨ÛŒÙ†Ú©Û•Ø±',
        icon: ExternalLink
      }
    },
    {
      icon: getPaymentMethodIcon(payment.payment_method),
      label: 'Ø´ÛÙˆØ§Ø²ÛŒ Ù¾Ø§Ø±Û•Ø¯Ø§Ù†',
      value: getPaymentMethodText(payment.payment_method),
      color: getPaymentMethodColor(payment.payment_method)
    },
    {
      icon: Calendar,
      label: 'Ø¨Û•Ø±ÙˆØ§Ø±ÛŒ Ù¾Ø§Ø±Û•Ø¯Ø§Ù†',
      value: new Date(payment.payment_date).toLocaleDateString('ar-IQ'),
      color: 'green'
    },
    {
      icon: User,
      label: 'ÙˆÛ•Ø±Ú¯Ø±',
      value: payment.user?.name,
      color: 'blue'
    },
  ];

  const relatedInvoice = payment.type === 'customer' ? payment.sale : payment.purchase;
  const relatedType = payment.type === 'customer' ? 'ÙØ±Û†Ø´ØªÙ†' : 'Ú©Ú•ÛŒÙ†';

  return (
    <AuthenticatedLayout>
      {/* Attachment Modal */}
      {showAttachment && (
        <AttachmentModal
          attachment={showAttachment}
          onClose={() => setShowAttachment(null)}
        />
      )}

      {/* Receipt Modal */}
      {showReceipt && (
        <PaymentReceipt
          payment={payment}
          company={company}
          relatedDebtInfo={relatedDebtInfo}
          onClose={() => setShowReceipt(false)}
        />
      )}

      <PageHeader
        title="Ø³Û•Ù†Ø¯ Ù‚Ø¨Ø¶ - Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ ÙˆÛ•Ø±Ú¯Ø±ØªÙ†ÛŒ Ù¾Ø§Ø±Û•"
        subtitle={`Ø³Û•Ù†Ø¯ÛŒ Ú˜Ù…Ø§Ø±Û• ${payment.reference_number || payment.id}`}
        action={{
          href: `/payments/${payment.id}/edit`,
          label: 'Ø¯Û•Ø³ØªÚ©Ø§Ø±ÛŒ',
          icon: Edit,
        }}
      />

      <div className="mx-auto space-y-6 max-w-7xl">
        {/* Header Card */}
        <Card className="overflow-hidden border-2 border-green-200 shadow-xl">
          <div className="p-6 bg-gradient-to-r from-green-600 to-emerald-700">
            <div className="flex flex-col justify-between gap-6 md:flex-row md:items-center">
              <div className="flex items-center gap-4">
                <div className="p-3 bg-white/20 rounded-xl backdrop-blur-sm">
                  <Receipt className="w-10 h-10 text-white" />
                </div>
                <div>
                  <h1 className="text-2xl font-black text-white">
                    Ø³Û•Ù†Ø¯ Ù‚Ø¨Ø¶ - {payment.type === 'customer' ? 'ÙˆÛ•Ø±Ú¯Ø±ØªÙ† Ù„Û• Ú©Ú•ÛŒØ§Ø±' : 'Ø¯Ø§Ù†Û•ÙˆÛ• Ø¨Û† Ø¯Ø§Ø¨ÛŒÙ†Ú©Û•Ø±'}
                  </h1>
                  <p className="mt-1 text-white/90">
                    {payment.type === 'customer' ? payment.customer?.name : payment.supplier?.name}
                  </p>
                </div>
              </div>

              <div className="flex flex-wrap gap-3">
                <button
                  onClick={handlePrintReceipt}
                  className="flex items-center gap-2 px-6 py-3 font-bold text-white transition-all shadow-lg bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl hover:from-blue-700 hover:to-blue-800"
                >
                  <Printer className="w-5 h-5" />
                  Ú†Ø§Ù¾Ú©Ø±Ø¯Ù†ÛŒ Ø³Û•Ù†Ø¯
                </button>
                <Link
                  href={`/payments/${payment.id}/edit`}
                  className="flex items-center gap-2 px-6 py-3 font-bold text-white transition-all bg-white/20 shadow-lg rounded-xl hover:bg-white/30"
                >
                  <Edit className="w-5 h-5" />
                  Ø¯Û•Ø³ØªÚ©Ø§Ø±ÛŒ
                </Link>
              </div>
            </div>
          </div>

          <div className="p-6">
            <div className="grid grid-cols-1 gap-4 mb-6 md:grid-cols-2 lg:grid-cols-4">
              {quickInfoCards.map((card, index) => (
                <QuickInfoCard key={index} {...card} />
              ))}
            </div>

            <div className="grid grid-cols-1 gap-6 lg:grid-cols-3">
              {/* Amount & Timing Card */}
              <div className="lg:col-span-2">
                <div className="p-6 border-2 border-emerald-200 bg-gradient-to-br from-emerald-50 to-green-50 rounded-2xl">
                  <div className="text-center">
                    <div className="mb-2 text-sm text-gray-500">Ø¨Ú•ÛŒ Ù¾Ø§Ø±Û•ÛŒ ÙˆÛ•Ø±Ú¯ÛŒØ±Ø§Ùˆ</div>
                    <div className="mb-2 text-5xl font-black text-emerald-600">
                      {formatCurrency(payment.amount, payment.currency)}
                    </div>
                    <div className="inline-flex items-center gap-2 px-6 py-2 text-lg font-bold rounded-full bg-gradient-to-r from-gray-100 to-gray-200">
                      <span className="text-gray-700">{payment.currency === 'IQD' ? 'Ø¯ÛŒÙ†Ø§Ø±' : 'Ø¯Û†Ù„Ø§Ø±'}</span>
                      <span className="text-gray-500">â€¢</span>
                      <span className={`px-3 py-1 rounded-full ${getStatusColor(payment.status)}`}>
                        {getStatusIcon(payment.status)}
                        <span className="mr-1">{getStatusText(payment.status)}</span>
                      </span>
                    </div>

                    {/* Ú©Ø§ØªÛŒ Ù¾Ø§Ø±Û•Ø¯Ø§Ù† */}
                    {paymentTiming && (
                      <div className={`mt-4 inline-flex items-center gap-2 px-4 py-2 rounded-lg ${paymentTiming.color}`}>
                        {paymentTiming.icon && <paymentTiming.icon className="w-4 h-4" />}
                        <span>{paymentTiming.text}</span>
                      </div>
                    )}
                  </div>
                </div>
              </div>

              {/* Debt Progress Card */}
              {relatedDebtInfo && (
                <div className="p-6 border-2 border-amber-200 bg-gradient-to-br from-amber-50 to-yellow-50 rounded-2xl">
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="font-bold text-gray-900">ğŸ’° Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ Ù‚Û•Ø±Ø²</h3>
                    <Percent className="w-5 h-5 text-amber-600" />
                  </div>
                  <div className="space-y-3">
                    <div className="grid grid-cols-3 gap-2">
                      <div className="p-2 text-center bg-white border border-gray-300 rounded-lg">
                        <div className="text-xs text-gray-600">Ú©Û†ÛŒ Ù‚Û•Ø±Ø²</div>
                        <div className="font-bold text-gray-900">
                          {formatCurrency(relatedDebtInfo.total_amount, payment.currency)}
                        </div>
                      </div>
                      <div className="p-2 text-center bg-white border border-green-300 rounded-lg">
                        <div className="text-xs text-gray-600">Ø¯Ø±Ø§Ùˆ</div>
                        <div className="font-bold text-green-600">
                          {formatCurrency(relatedDebtInfo.paid_amount, payment.currency)}
                        </div>
                      </div>
                      <div className="p-2 text-center bg-white border border-red-300 rounded-lg">
                        <div className="text-xs text-gray-600">Ù…Ø§ÙˆÛ•</div>
                        <div className="font-bold text-red-600">
                          {formatCurrency(relatedDebtInfo.remaining_amount, payment.currency)}
                        </div>
                      </div>
                    </div>
                    <div className="pt-2 border-t border-amber-300">
                      <div className="flex justify-between text-sm">
                        <span className="text-amber-700">Ù¾Ø§Ø±Û•ÛŒ Ø¯Ø±Ø§Ùˆ</span>
                        <span className="font-bold text-amber-800">
                          {relatedDebtInfo.total_amount > 0
                            ? ((relatedDebtInfo.paid_amount / relatedDebtInfo.total_amount) * 100).toFixed(1)
                            : 0}%
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* Debt Progress Bar */}
            {relatedDebtInfo && (
              <div className="mt-6">
                <DebtProgress
                  total={relatedDebtInfo.total_amount}
                  paid={relatedDebtInfo.paid_amount}
                  remaining={relatedDebtInfo.remaining_amount}
                  currency={payment.currency}
                />
              </div>
            )}
          </div>
        </Card>

        {/* Details Grid */}
        <div className="grid grid-cols-1 gap-6 lg:grid-cols-3">
          {/* Reference & Notes */}
          <Card className="border-2 border-gray-200">
            <div className="p-6">
              <h3 className="flex items-center gap-2 pb-3 mb-6 font-bold text-gray-900 border-b border-gray-200">
                <FileText className="w-5 h-5 text-blue-600" />
                Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ Ù†ÙˆÙˆØ³ÛŒÙ†
              </h3>
              <div className="space-y-6">
                <div>
                  <div className="flex items-center justify-between mb-2">
                    <div className="text-sm text-gray-600">Ú˜Ù…Ø§Ø±Û•ÛŒ Ø³Û•Ù†Ø¯</div>
                    <button
                      onClick={() => copyToClipboard(payment.reference_number || payment.id)}
                      className="text-blue-600 hover:text-blue-800"
                    >
                      <Copy className="w-4 h-4" />
                    </button>
                  </div>
                  <div className="p-3 font-bold text-gray-900 rounded-lg bg-gray-50">
                    {payment.reference_number || '---'}
                  </div>
                  {copied && (
                    <div className="mt-1 text-sm text-green-600">Ú©Û†Ù¾ÛŒ Ú©Ø±Ø§ÙˆÛ•!</div>
                  )}
                </div>

                {payment.invoice_number && (
                  <div>
                    <div className="mb-2 text-sm text-gray-600">Ú˜Ù…Ø§Ø±Û•ÛŒ ÙØ§Ú©ØªÙˆØ±</div>
                    <div className="p-3 font-bold text-gray-900 rounded-lg bg-gray-50">
                      {payment.invoice_number}
                    </div>
                  </div>
                )}

                {payment.notes && (
                  <div>
                    <div className="mb-2 text-sm text-gray-600">ØªÛØ¨ÛŒÙ†ÛŒÛ•Ú©Ø§Ù†</div>
                    <div className="p-4 border border-yellow-200 rounded-lg bg-yellow-50">
                      <p className="text-gray-700 whitespace-pre-line">{payment.notes}</p>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </Card>

          {/* Bank Information */}
          {(payment.bank_name || payment.account_number || payment.transaction_id) && (
            <Card className="border-2 border-green-200">
              <div className="p-6">
                <h3 className="flex items-center gap-2 pb-3 mb-6 font-bold text-gray-900 border-b border-gray-200">
                  <Building2 className="w-5 h-5 text-green-600" />
                  Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ Ø¨Ø§Ù†Ú©
                </h3>
                <div className="space-y-4">
                  {payment.bank_name && (
                    <div>
                      <div className="text-sm text-gray-600">Ù†Ø§ÙˆÛŒ Ø¨Ø§Ù†Ú©</div>
                      <div className="font-bold text-gray-900">{payment.bank_name}</div>
                    </div>
                  )}

                  {payment.account_number && (
                    <div>
                      <div className="text-sm text-gray-600">Ú˜Ù…Ø§Ø±Û•ÛŒ Ù‡Û•Ú˜Ù…Ø§Ø±</div>
                      <div className="font-mono font-bold text-gray-900">{payment.account_number}</div>
                    </div>
                  )}

                  {payment.transaction_id && (
                    <div>
                      <div className="text-sm text-gray-600">Ú˜Ù…Ø§Ø±Û•ÛŒ Ù…Ø§Ù…Û•ÚµÛ•</div>
                      <div className="font-mono font-bold text-gray-900">{payment.transaction_id}</div>
                    </div>
                  )}
                </div>
              </div>
            </Card>
          )}

          {/* Attachments */}
          <Card className={`border-2 ${payment.attachment ? 'border-blue-200' : 'border-gray-200'}`}>
            <div className="p-6">
              <h3 className="flex items-center gap-2 pb-3 mb-6 font-bold text-gray-900 border-b border-gray-200">
                {payment.attachment ? (
                  <ImageIcon className="w-5 h-5 text-blue-600" />
                ) : (
                  <FileText className="w-5 h-5 text-gray-400" />
                )}
                Ù¾Û•ÛŒÙˆØ³ØªÛ•Ú©Ø§Ù†
              </h3>

              {payment.attachment ? (
                <div className="space-y-4">
                  <div className="p-4 border-2 border-blue-200 rounded-xl bg-gradient-to-r from-blue-50 to-indigo-50">
                    <div className="flex items-center gap-4">
                      <div className="p-3 bg-white shadow-sm rounded-xl">
                        {payment.attachment.match(/\.(jpg|jpeg|png|gif)$/i) ? (
                          <ImageIcon className="w-8 h-8 text-blue-600" />
                        ) : (
                          <FileText className="w-8 h-8 text-blue-600" />
                        )}
                      </div>
                      <div className="flex-1">
                        <div className="font-bold text-gray-900 truncate">
                          {payment.attachment.split('/').pop()}
                        </div>
                        <div className="text-sm text-gray-600">ÙˆÛÙ†Û•ÛŒ Ú†ÛÚ© ÛŒØ§Ù† Ù¾Û•Ú•Û•ÛŒ Ø¨Ø§Ù†Ú©</div>
                      </div>
                    </div>
                  </div>

                  <div className="flex gap-3">
                    <button
                      onClick={() => setShowAttachment(payment.attachment)}
                      className="flex items-center justify-center flex-1 gap-2 px-4 py-3 font-bold text-white transition-colors bg-blue-600 rounded-xl hover:bg-blue-700"
                    >
                      <Eye className="w-4 h-4" />
                      Ø¨ÛŒÙ†ÛŒÙ†
                    </button>
                    <a
                      href={`/storage/${payment.attachment}`}
                      download
                      className="flex items-center justify-center flex-1 gap-2 px-4 py-3 font-bold text-gray-700 transition-colors border-2 border-gray-300 rounded-xl bg-gray-50 hover:bg-gray-100"
                    >
                      <Download className="w-4 h-4" />
                      Ø¯Ø§Ú¯Ø±ØªÙ†
                    </a>
                  </div>
                </div>
              ) : (
                <div className="py-8 text-center">
                  <FileText className="w-12 h-12 mx-auto mb-3 text-gray-400" />
                  <p className="text-gray-500">ÙØ§ÛŒÙ„ÛŒ Ù¾Û•ÛŒÙˆØ³Øª Ø¨ÙˆÙˆÙ†ÛŒ Ù†ÛŒÛŒÛ•</p>
                </div>
              )}
            </div>
          </Card>
        </div>

        {/* Stats Card */}
        <Card className="border-2 border-green-200">
          <div className="p-6">
            <h3 className="pb-3 mb-6 font-bold text-gray-900 border-b border-gray-200">Ø¦Ø§Ù…Ø§Ø±Û•Ú©Ø§Ù†ÛŒ Ø³Û•Ù†Ø¯</h3>
            <div className="grid grid-cols-1 gap-4 md:grid-cols-4">
              <div className="p-4 text-center border-2 border-emerald-200 bg-emerald-50 rounded-xl">
                <div className="text-2xl font-black text-emerald-600">
                  {formatCurrency(payment.amount, payment.currency)}
                </div>
                <div className="mt-1 text-sm text-emerald-800">Ø¨Ú•ÛŒ Ù¾Ø§Ø±Û•ÛŒ ÙˆÛ•Ø±Ú¯ÛŒØ±Ø§Ùˆ</div>
              </div>

              <div className="p-4 text-center border-2 border-blue-200 bg-blue-50 rounded-xl">
                <div className="text-2xl font-black text-blue-600">
                  {formatDate(payment.payment_date)}
                </div>
                <div className="mt-1 text-sm text-blue-800">Ø¨Û•Ø±ÙˆØ§Ø±ÛŒ ÙˆÛ•Ø±Ú¯Ø±ØªÙ†</div>
              </div>

              <div className="p-4 text-center border-2 border-purple-200 bg-purple-50 rounded-xl">
                <div className="text-2xl font-black text-purple-600">
                  {payment.user?.name.split(' ')[0]}
                </div>
                <div className="mt-1 text-sm text-purple-800">ÙˆÛ•Ø±Ú¯Ø±</div>
              </div>

              <div className="p-4 text-center border-2 border-amber-200 bg-amber-50 rounded-xl">
                <div className="text-2xl font-black text-amber-600">
                  {payment.type === 'customer' ? 'Ú©Ú•ÛŒØ§Ø±' : 'Ø¯Ø§Ø¨ÛŒÙ†Ú©Û•Ø±'}
                </div>
                <div className="mt-1 text-sm text-amber-800">Ø¬Û†Ø±ÛŒ Ø³Û•Ù†Ø¯</div>
              </div>
            </div>
          </div>
        </Card>

        {/* Action Buttons */}
        <div className="flex flex-wrap gap-4 p-6 border-2 border-gray-200 rounded-2xl bg-gradient-to-r from-gray-50 to-gray-100">
          <button
            onClick={() => router.get('/payments')}
            className="flex items-center gap-3 px-8 py-3.5 font-bold text-gray-700 border-2 border-gray-300 rounded-xl bg-gradient-to-r from-white to-gray-50 hover:from-gray-50 hover:to-gray-100 transition-all"
          >
            <ArrowRight className="w-5 h-5" />
            Ú¯Û•Ú•Ø§Ù†Û•ÙˆÛ• Ø¨Û† Ù„ÛŒØ³Øª
          </button>
          <button
            onClick={handlePrintReceipt}
            className="flex items-center gap-3 px-8 py-3.5 font-bold text-white bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl hover:from-blue-700 hover:to-blue-800 transition-all"
          >
            <Printer className="w-5 h-5" />
            Ú†Ø§Ù¾Ú©Ø±Ø¯Ù†ÛŒ Ø³Û•Ù†Ø¯
          </button>
          <Link
            href={`/payments/${payment.id}/edit`}
            className="flex items-center gap-3 px-8 py-3.5 font-bold text-white bg-gradient-to-r from-green-600 to-emerald-700 rounded-xl hover:from-green-700 hover:to-emerald-800 transition-all"
          >
            <Edit className="w-5 h-5" />
            Ø¯Û•Ø³ØªÚ©Ø§Ø±ÛŒÚ©Ø±Ø¯Ù†
          </Link>
        </div>
      </div>
    </AuthenticatedLayout>
  );
}
